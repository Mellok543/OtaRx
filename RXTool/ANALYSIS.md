# Анализ папки `RXTool`

## Что это за проект
`RXTool` — это desktop-приложение на **C# / .NET 8 WinForms** для настройки и прошивки RX-устройств по Wi‑Fi (ориентировано на устройства, которые поднимают web-интерфейс на `10.0.0.1`).

Основные сценарии:
1. Найти и подключиться к Wi‑Fi сети приёмника по правилам из профиля.
2. Залить бинарную прошивку (`firmware.bin`) в endpoint `/update`.
3. Применить Bind Phrase (через UID из 6 байт) и частотный/регуляторный домен через JSON API.

## Структура файлов
- `Program.cs` — точка входа WinForms.
- `MainForm.cs` — весь UI и orchestration бизнес-процесса (подключение к Wi‑Fi, upload, bind/domain, reboot).
- `RxApi.cs` — HTTP-клиент для ping/upload/POST JSON + прогресс загрузки.
- `WifiHelper.cs` — обвязка над `netsh` для поиска SSID, добавления профиля Wi‑Fi и подключения.
- `ConfigModels.cs` — модели `config.json`.
- `JsonTemplate.cs` — подстановка UID в JSON-шаблон bind-конфига.
- `config.json` — набор профилей устройств (SSID match, пароль, API endpoint'ы, bind UID, domain presets).
- `RXTool.csproj` — WinForms проект с копированием `config.json` рядом с exe.

## Архитектура и поток выполнения

### 1) Загрузка конфигурации
При запуске форма читает `config.json` из директории приложения, заполняет список профилей и связанные выпадающие списки (Bind Phrase / Domain).

### 2) Операция «Залить прошивку»
`MainForm.DoFlashOnly()`:
- валидирует профиль и путь к `.bin`;
- ждёт появления нужной Wi‑Fi сети + подключается (`WifiHelper.WaitAndConnectAsync`);
- проверяет доступность `http://10.0.0.1/` (`RxApi.PingAsync`);
- делает multipart upload в `upload.url` c progress bar (`RxApi.UploadAsync`).

### 3) Операция «Установить Bind + Частоту»
`MainForm.DoSetBindAndDomain()`:
- валидирует выбранный bind/domain и UID (ровно 6 байт 0..255);
- подключается к сети и проверяет доступность устройства;
- строит bind JSON: template + замена `"$UID6"` на массив;
- POST в bind endpoint;
- POST доменного JSON в endpoint `options.json`;
- при необходимости делает reboot и ждёт 15 секунд.

## Сильные стороны
- Конфигурируемый подход через `config.json`: можно добавлять новые устройства/профили без перекомпиляции.
- Поддержка разных правил поиска SSID (`exact`, `startsWith`, `regex`).
- Cancellation (`STOP`) и детализированный лог в UI.
- Прогресс загрузки прошивки через кастомный `HttpContent`.

## Ограничения и риски
1. **Платформенная привязка к Windows**: Wi‑Fi управление реализовано через `netsh`.
2. **Хрупкая подстановка UID**: `JsonTemplate.BuildBindJson` делает строковую замену `"$UID6"`; если шаблон изменится, можно получить невалидный JSON или неправильное место замены.
3. **Слабая обработка ошибок `netsh`**: ошибки логируются первой строкой, но нет строгой проверки exit code.
4. **Отсутствие unit-тестов** для критичных мест (`PickSsid`, `BuildBindJson`, сериализация domain body).
5. **Секреты в plain text**: Wi‑Fi пароли лежат в `config.json`.
6. **UI + логика в одном классе** (`MainForm`), что усложняет сопровождение и тестирование.

## Рекомендации по улучшению
- Вынести доменную логику в сервисы (`IRxApi`, `IWifiConnector`, `IProfileRepository`) и оставить в форме только UI.
- Заменить string replace в `JsonTemplate` на работу с `JsonDocument/JsonNode` и явное присваивание поля `uid`.
- Проверять `netsh` exit code и возвращать типизированные ошибки.
- Добавить unit-тесты минимум для:
  - `WifiHelper.PickSsid` (все режимы + edge cases),
  - `JsonTemplate.BuildBindJson` (валидность JSON и корректность UID),
  - валидации конфигов.
- Добавить проверку структуры `config.json` при старте и человеко-понятные ошибки по конкретным полям.

## Итог
Папка `RXTool` содержит рабочий инструмент для прошивки и настройки RX по локальному Wi‑Fi API с удобной конфигурацией профилей. Проект практичный и функциональный, но требует усиления надёжности (ошибки/валидация), тестопригодности (декомпозиция) и безопасности (пароли/секреты).
